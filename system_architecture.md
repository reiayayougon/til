### カーネル

ログイン中の前ユーザーにメッセージを送信するコマンド
```
wall
```

Linuxはマルチユーザー、マルチタスクなOSであるため、複数人で同時に使用することができる。
そのためシステム停止作業は多数のユーザーに影響が出てしまう。そういった案内を通知するため、
ログイン中の全ユーザにメッセージを送信するwallコマンドがある。

ESP(EFIシステムパーティション)の説明
- ブートローダや起動に必要なドライバなどが置かれる
- UEFIを使ったシステムの領域

解説
ESP(EFIシステムパーティション)はUEFIシステムにおいて、物理的なマシンを起動し、ファームウエアが読み込まれた後、その後の起動シーケンスで最初にアクセスされる領域になる。
ESPはFATでフォーマットされ、ブートローダなどの他、起動に必要なドライバやプログラムも置かれる。
UEFIシステムではブートローダは必ずしも必要ではなく、UEFIブートマネージャから直接カーネルを起動することも可能。

UEFI：従来のBIOSの代替として採用された規格で、コンピュータの起動プロセスやハードウエアの初期化を行うファームウエアの新しい形式。UEFIは高度な機能や拡張性を提供し、従来のBIOSよりも柔軟で効率的な起動プロセスを可能にする。

ESP：UEFIシステムで、物理的なマシンを起動した後、UEFIファームウエアが最初にアクセスする領域。

起動シーケンス：コンピュータが電源を入れたときから、オペレーティングシステムが実行されるまでの一連の手順やプロセスの流れをさす。UEFIにおいて、ESPが起動シーケンスの初めにアクセスされ、そこから必要なファイルが読み込まれ、システムが起動される。

FAT(File Allocation Table)：ファイルシステムの一つであり、ESPが使用するフォーマットの一部。FATはディスク上のファイルの配置や管理を行う。UEFIがESPを読み込むためには、FATでフォーマットされている必要がある。

ブートローダ：コンピュータが起動した時に実行される役割を担う。ESPにはこれらのブートローダが配置され、UEFIファームウエアによって起動される。

カーネルの特定のモジュールが原因で、NICが不安定な動作をしている。今後はシステムの起動時にそのモジュールをロードしないようにして、NICの利用を続けたい。適切な対応は
/etc/modprobe.dディレクトリの設定ファイルでblacklistを指定する

blasklist（ブラックリスト）を設定することにより、「ロードすると問題が発生するモジュールや不要なモジュールを、システム起動時にロードしない」ようにできる。



### システム起動時においてのカーネルの説明

・高度にハードウエアを認識・制御し、ルートファイルシステムのマウントなど様々な初期化処理を行う
・/sbin/initを起動する

解説
カーネルは起動されると、高度にハードウエアを認識・制御し、ルートファイルシステムのマウントなど様々な初期化処理を行う。ブートローダーはカーネルと初期RAMディスク(initramfs)の内容をメモリに展開し、カーネルはメモリ上に展開された初期RAMディスク内の、ファイルシステムへアクセスするために必要なドライバやスクリプトを使用してルートファイルシステムをマウントする。その後initという特別な最初のプロセスをルートファイルシステムから起動する。
SysVinitと呼ばれる従来のinitプログラムを採用しているシステムでは、initプロセスとして「/sbin/init」が起動される。なお、カーネルはブートローダーの次に起動される。

ブートローダーとは、コンピュータを起動したときに呼び出されて、OSとかを動かすプログラムのこと。

電源投入→BIOS起動→ブートローダー起動→OS開始
BIOS、ブートローダ、カーネル、initの順

BIOSはパソコンの電源が入って最初に動く、主にハードウエアを制御するプログラム。
一般的にBIOSは「マザーボード」と呼ばれる、パソコンの中にある部品にくっついている。
電源が入ると、マザーボードに電源が流れる。マザーボードに電源が流れると、BIOSが起動。
そのBIOSは、ハードディスクを動かしたりキーボーに準備をさせる。OSが動くのはその後。

復習
コンピュータの電源を入れると、まずBIOSが起動し、記憶装置(HDD)などに関しての最低限の認識をして起動デバイスの優先順位決定。その後、優先順位に従って各デバイスの先頭セクタにあるMBR(ブート用の特殊領域。ブートローダが格納されている)を読み込み、得られたブートローダに制御を移す。ブートローダが得られない場合は次のデバイスのMBRを読み込む。
### カーネルのログの記録

カーネルのログの記録ファイル
```
/var/log/message
```

カーネル情報を表示
```
lsmod   #カーネルモジュールの情報を表示
cat /proc/modules   #このファイルにはロードされているカーネルモジュールの情報が格納されている
```

カーネルモジュールとは、カーネルで扱うべきいろいろな機能を独立した部品のようなもの。モジュールとしてカーネルから切り離すことでカーネル本体のサイズを小さくし、必要な機能だけをロードしたり、不要な機能はアンロードするというように使用できる。

### 再起動コマンド
「Rwbooting in 10 minutes」というメッセージ表示して23:00に再起動するコマンド
```
shutdown -r 23:00 "Rebooting in 10 minutes"
shutdown -r +10 "Rebooting in 10 minutes"
```

### /etc/inittab

システムの初期化トランレベルの設定に関する情報を保持。initシステムを使用してるシステムで見られるファイル。
簡単にいうと、システムの起動とランレベルの管理に関する設定を保持するファイルであり、システムの初期化や各ランレベルでの挙動を制御するための重要なファイル。


ランレベルの設定：ランレベルは、システムが動作している状態を示すもの。通常、マルチユーザモードやシングルユーザモードなどがある。異なるランレベルで実行されるプロセスやサービスの設定が含まれている。

起動時のジョブスケジューリング：「/etc/inittab」はシステムが起動したときに実行されるジョブ(タスクやプロセス)を定義。これにより、システムが起動したときにに特定の処理を実行できる。

コンソール制御：ユーザが物理的なコンソールや端末を使用する際の設定も含まれる。ログインプロントの表示やシャットダウンの制御などが該当する。

SysVinitとは/etc/inittabを使用する伝統的なinitシステムの一つ
sustemdとはinitシステム。/etc/inittabを使用せず、独自の仕組みや設定ファイルを使用している。systemdはSysVinitシステムの代替として開発され多くのディストビューションで採用されている。
Upstartもinitシステム。/etc/inittabを使用せず独自の設定やジョブ定義を持っている。

SisVinitの設定ファイル「/etc/inittab」を編集したとき即座に変更を反映させるコマンド
```
telinit q
telinit Q
init q
init Q

```
### ブートローダ
ブートローダはカーネルと初期RAMディスク(initramfs)の内容をメモリ上に展開し、カーネルはメモリ上に展開された初期RAMディスク内の、ファイルシステムへアクセスするために必要なドライバやスクリプトを使用してルートファイルシステムをマウントする。その後、initという特別な最初のプロセスをルートファイルシステムから起動。カーネルイメージと、カーネルのバージョンに対応する初期RAMディスクは「/boot」ディレクトリに格納される。初期RAMディスクは展開してイメージ内のディレクトリ・ファイルを参照することができる。

初期RAM ディスクは、カーネルが起動する初期段階で使用される一時的なファイルシステム。このファイルシステムには、システムの初期化に必要なファイル、ドライブ、スクリプトが含まれおり、特にルートファイルシステムがまだマウントされていない初期の段階で必要。

カーネルイメージとは、カーネルがバイナリ形式で格納されたファイルを指す。

初期RAMディスクの説明
- カーネルのバージョンごとに内容が異なる
- ファイルシステムへアクセスするのに必要なドライバやスクリプトが含まれている
- カーネルイメージと同様に/bootディレクトリに格納される

### CPUに関する情報

CPUに関する情報を確認できる
```
/proc/cpuinfo
```

解説
/procディレクトリはプロセス、ハードウエア及びシステムリソースなどの情報を扱うための仮想的なファイルシステム。そのため、ハードディスク上にファイルは存在せず、システムが起動する際にメモリ上に作成される。
/procディレクトリ配下に格納されているファイルの多くはASCIIテキスト形式なので、catコマンドなどで内容が確認できる。以下のコマンドでも効率的に確認できる。
```
lspci  #PCIデバイスに関する情報

lsmod  #ロードされているカーネルモジュールに関する情報表示

lsusb  #USBデバイスに関する情報を表示
```

### systemd

システムが起動する際、systemdが最初に読み込む設定ファイル(Unit)は、「/etc/systemd/system/default.target」。これが起動時にどのサービスやプロセスを有効にするかを指定するもので、SysVinitでのランレベルに相当する。
SysVinitとは、従来のUnixシステムで使われていたinitシステムの一つで、ランレベルと呼ばれる異なる運用モードを定義していた。systemdでも同様の概念があり、それが「ターゲット(Target)」。SysVinitとsystemdのターゲットは、システムの動作状態を定義するために使われる。

systemdが稼働するシステムにおいて、次回起動時のランレベルの確認作業
```
cd /ect/systemd/sytem
ls -| default.target
```
解説
システム起動時に読み込まれるUnitは/ect/systemd/sytem/default.target。default.targetをSysVinitでのランレベルに相当するUnitへのシンボリックとして作成することで、期待するサービス群を起動できるようになる。

systemdの動作するシステムにおいて、次回起動時にメンテナンスをお行うために最低限のシステムサービス状態で起動させたい。次回起動時のターゲットとして指定するのは
```
runlevel1.target
rescue.target
```

#### SysVinitのランレベルに相当するsystemdターゲット

|SysVinit(ランレベル)|systemd(ターゲット)|
|----|----|
|0|poweroff.taget|
|1|rescue.target|
|2-4|multi-user.target|
|5|graphical.target|
|6|reboot.target|

シンボリックとは、データの場所を示す特殊な種類のファイル。例えば、「default.target」が指している先を変えることで、システムのデフォルトの動作を変更できる。

systemdが稼働するシステムにおいて、次回起動時のターゲットが確認できるsystemctlのサブコマンド
```
get-default
```

systemdはSysVinitを置き換える新しいinitの仕組み。
systemdで扱う処理はUnitという単位で管理。Unitは設定ファイルであり、Unitの設定に従って、systemd自体が処理を実行する。SysVinitのようにスクリプトを実行する訳ではない。
Unitには各機能ごとに拡張子が割り当てられおり、拡張子を見ることでどういった機能のためのUnitかが判別できるようになっている。
|拡張子|機能|
|----|----|
|device|各種デバイスを管理する|
|mount|ファイルシステムのマウントを管理する|
|service|サービスを制御するUnit|
|swap|スワップ領域を管理する|
|target|複数のサービスを一つのグループにするためのUnit|

また、SysVinitではプロセスをPIDによって管理していましたが、systemdではcgroupsというLinuxカーネルの機能によってプロセスのリソースを管理できる。
systemdはUpstartと同様、各サービスを並列起動することができる。そのため、順次起動していくSysVisinitに比べて高速なシステム起動や停止が行える。
システム起動時に最初に読み込まれるUnitは/ect/systemd/system/default.target。
default.targetをSysVinitでのランレベルに相当するUnitへのシンボリックとして作成することで、期待するサービス群を起動できるようになる。

```
systemctl status httpd  #各サービスの稼働状況や起動設定を管理するにはsystemctlコマンド
```

```
journalctlコマンドのオプションでdmesgコマンドと同じ情報を得られるオプション
-k
--dmesg
```

systemdの動作するシステムではsystemd-journaldデーモンを動作させ、ログの一元管理を行う。system-journaldはsystemdから起動したプロセスの標準出力やsyslogへのログメッセージをバイナリ形式で記録する。
systemd-journakdが書き込むログファイルはバイナリ形式のため、catコマンドで中を見ることができない。
journalctlコマンドを使用する。
-kオプションまたは--dmesgオプションで、dmesgコマンドと同じ情報が出力される。

systemdが管理するサービスを再起動させるためのsystemctlコマンドのサブコマンド
```
restart
```

systemdが利用できるユニットの一覧を取得

```
systemctl list-unit-files
```

systemdが稼働するシステムにおいて、システム起動時にhttpdサービスが自動起動するようにするコマンド
```
systemd enable httpd
```
解説
各サービスの稼働状況や起動設定を管理するにはsystemctlコマンドを使用

```
書式：systemctl サブコマンド [Unit名]
```
主なサブコマンド

|サブコマンド|用途|
|----|----|
|disable|サービスの自動起動を無効にする|
|enable|サービスの自動起動を有効にする|
|get-default|次回起動時のターゲットを表示する|
|halt|システムを停止しhalt状態にする(電源はONのまま)|
|is-activ|サービスが稼働しているかを表示|
|list-unit-file|全てのUnit定義ファイルを一覧表示|
|reboot|システムを再起動|
|relode|サービス設定ファイルを再読み込み|
|restart|サービスを再起動|
|set-default|次回起動時のターゲットを設定|
|start|サービスをスタート|
|status|サービスの状態表示|
|stop|サービス停止|
|poweroff|システムを停止し電源切断(電源OFF)|


systemdの動作するシステムにおいて、サーバとして動作させるのに適切な起動時のターゲット
```
runlevel3.target
multi-user.target
```
解説
ランレベル5でも必要なサービスを起動させることは可能だが、グラフィカルログインやディスクトップを生業させることは可能だが、グラフィカルログインやディスクトップを制御させるプロセスも起動させるため、サーバとして稼働するには無駄なリソースを使用してしまう。
runlevel3.targetとmulti-user.targetがサーバとして動作させるのに適切な起動時のターゲットとされる理由
- CLI操作が主流：サーバ環境では通常、CLIを使用して操作。CLIは、リモートでのアクセスやスクリプトを利用した管理が容易であり、遠隔地からの操作もしやすい。runlevel3.targetとmulti-user.targetは、CLIが優先されるランレベルを表す。

- リソースの最適利用

- セキュリティの向上：グラフィカルな環境はセキュリティ上のリスクを増大させる可能性がある。サーバ環境では不必要なサービスやプロセスを削減し、セキュリティを向上させることが求められる。CLI環境がこれに寄与する。


### SysVinit

SysVinitを採用したシステム起動時におけるinitの説明
設定ファイル「/etc/inittab」の記述に基づいて、自動起動するべきプロセスを立ち上げるなど、アプリケーションレベルの初期化を行う。
解説
SysVinitと呼ばれる従来のinitプログラムを採用しているシステムでは、カーネルから起動されるinitプロセスとして/sbin/initを起動する。initは起動されると、設定ファイルetc/inittabの記述に基づいて、自動起動するべきプロセスを立ち上げるなど、アプリケーションレベルの初期化を行う。
initはカーネルによって最初に起動されるプロセスで、PID（プロセスID）は必ず１。
以降、initプロセスの先祖(直接・間接的な呼び出し元)として存在し続ける。
最近のシステムではinitプログラムとして、初期化処理を高速化したUpstartやsystemdを採用している場合がある。
その場合は基本的に/etc/inittabファイルは使用しない。


### USBのデバイスクラス

```
Mass Storage Class
```

USBデバイスはいくつかのデバイスクラス(種類)に分かれている。
それぞれのデバイスクラスにはクラスドライバという汎用ドライバが用意されている。
|デバイスクラス|デバイス|
|----|----|
|HID|キーボード、マウス、ジョイスティックなど|
|Mass Storage Class|ハードディスク、USBメモリーなど|
|ACM Communication Device Class|モデム、TAなど(通信機器)|
|Audio Class|スピーカー、マイク|

モデム：デジタル信号をアナログ信号に変換し、逆にアナログ信号をデジタル信号に変換する装置。モデムは通常、コンピュータと電話線などの通信回路を介して通信する際に使用される。モデムはデータ通信やインターネット接続に利用されたが、現代では広帯域のネットワークが一般的になり、従来のダイヤルアップモデムの使用は減少している。

ターミナルアダプタ(TA)：通信機器とコンピュータを接続し、データ通信を可能にする装置。TAはモデムと同様に、通信プロトコルに基づいて通信を行うが、通信回線には電話線だけでなく、ISDNやDSLなども利用される。



接続されたUSBデバイスの情報表示
```
cat /proc/bus/usb/devices
lsudb
```


### システム再起動
今すぐシステムを再起動するコマンド

```
reboot
shutdown -r now
telinit 6
```
システムを再起動させる方法はいくつかある

- [ ] rebootコマンドの実行
- [ ] init 6またはtelinit 6コマンドを実行する。ランレベルを６に変更するとシステムが再起動
- [ ] shutdoenコマンドを使用する

shutdown [オプション] 時間 [メッセージ]

|オプション|説明|
|----|----|
|-h|システム停止|
|-r|システム再起動|
|-k|シャットダウンは行わず、ログイン中の前ユーザーにメッセージを送る|
|-c|実行中のシャットダウンをキャンセル|

### 大容量記憶装置

大量のデータのための記憶装置を「大容量記憶装置(mass storage device)」という。
OSをインストールして起動ディスクとして使用したり、大容量のデータを保管するために使用。

特徴
- SSDはSATAインターフェース以上の速度でアクセスできる
- SSDとUSBフラッシュドライブは、HDDのような機械な故障は起きない
- OSの起動ディスクとして使用できる
- 容量当たりのコスパが高いのはHDDである

主な大容量記憶装置

|装置|内容|
|----|----|
|HDD|容量が大きくコスパが高い記憶装置。データの記憶には磁気を使用。コンピュータに内蔵できるものと外付けできるものがある。装置内部の「プラッタ」という回転する円盤に対してデータの読み書きを行うので、衝撃によりプラッタに傷ついてデータが破損する場合もある。|
|USBフラッシュドライブ|USBメモリと呼ばれる記憶装置。内部の「フラッシュメモリ(不揮発性の半導体メモリ)」にデータの読み書きを行う。フラッシュメモリには書き換え回数やデータ保存期間に制限があり、長期保存には向いてない|
|SSD|ディスクという名前がついているが、記憶装置として半導体メモリを用いており、実際にはフラッシュメモリに属する機器。USBフラッシュメモリと同様に長期保存には向いてない。ランダムアクセス性能に優れており、省電力で静音、非接触メディアであるため耐振動・衝撃性が高く、近年ではHDDの代わりに使用されていることも多い。フラッシュメモリの高速性を引き出すため、SATAより高速な「NVMe」インターフェースで接続するタイプのもある。|


### IRQ
IRQに関する情報が格納されているファイル
```
/proc/interrupts
```
IRQ(Interrupt ReQuest)とは、マウスやキーボードなどの周辺機器(デバイス)からCPUへの割り込み要求のこと。IRQには０から1,2,3のように順位番号がつき、そのうちのいくつかは特定のデバイスに割り当てられる。

### ランレベル

|ランレベル|説明|
|----|----|
|0|システム停止|
|1/s/S|シングルユーザモード|
|2|マルチユーザモード(テキストログイン、NFSなし)|
|3|マルチユーザモード(テキストログイン)|
|4|未使用|
|5|マルチユーザモード(GUIログイン)|
|6|システム起動|

### PCI
lspciコマンドで取得できる情報
- [ ] ベンダー名(ベンダーID)
- [ ] バスの速度
- [ ] IRQ番号
- [ ] I/Oポートアドレス

解説
PCI(Peripheral Components Interconnect)デバイスとはPCIバスに接続されたデバイスのこと。PCIデバイスにはネットワークカードやSCSIカードなどがある。
PCIデバイスの情報表示コマンドはlspci
PCIバスは、コンピュータシステム内でデバイスがデータをやり取りするためのバス(経路や接続)の一つ。これにより、異なる種類のデバイスがお互いに通信でき、システムの拡張やカスタマイズが可能になる。
PCIバスは、標準なハードウエアインターフェースで、様々なメーカーのデバイスが互換性を持ちながら接続できるように設計されている。

まとめると
PCIデバイスはコンピュータに追加の機能や機器を接続するための拡張カードであり、PCIバスはそれらのデバイスがシステム内で通信するための経路を提供する。

### メモリ
メモリの使用状況を確認できるファイル
```
/proc/meminfo
```

### SCSIデバイス

SCSIデバイスに関する情報が確認できるファイル
```
/proc/scsi/scsi
```
解説
/procディレクトリはプロセス、ハードウエア及びシステムのリソースなどの情報を扱うための仮想的なファイルシステムである。そのため、ハードディスク上には存在せず、システムが起動する際にメモリ上に作成される。

SCSIデバイスは、複数の異なる種類のコンピュータシステムと周辺機器を接続するための規格。
これには、ハードディスクドライブ、光学ドライブ(CD-ROM,DVD-ROM)、など周辺機器が含まれる。
SCSIは高い転送速度安く数のデバイスを同時に制御する能力など、特にサーバや専門コンピュータで使用されることがある。

### /var/log

システムの起動が、何らかのエラーにより失敗した。そこでレスキューディスクを利用し、起動に成功した。エラーの原因を究明するためには/var/log配下のファイルの内容から調査する。
ログが格納されている主なディレクトリは/var/log。

### /var/log/dmesg
/var/log/dmesgの内容がリセットされるタイミングは『再起動時』。

/var/log/dmesgは、システムの起動時点のカーネルメッセージ(リングバッファの内容)が保存されるログファイル。システムの起動障害を調査する際に役立つ。

/var/log/dmesgは起動の度に新しい内容で置き換えられる。このファイルはファイルシステムによって存在しな場合がある。
カーネルのリングバッファは、カーネルのログメッセージを一時的に保存する固定サイズのデータ領域であり、マシンの再起動やシャットダウンによってリセットされる。また、運用中にいっぱいになると古い情報から上書きされていく。
リングバッファの現在の内容は、dmesgコマンドで確認できる。
システム起動直後は、/var/log/dmesgファイルとdmesgコマンドが表示する情報は同じ内容。
しかし、時間の経過とともにリングバッファ内の古い情報が上書きされる可能性があるため、dmesgコマンドでは起動時の情報を常に確認できるわけではない。一方、/var/log/dmesgの内容は稼働中に変化しないので、いつでも起動時のカーネルメッセージが確認できる。

リングバッファ：データを一時的に保存するためのデータ構造で、固定サイズの循環バッファとも呼ぶ。
dmesg --clearコマンドはカーネルのリングバッファをクリアするが、これにより/var/log/dmesgファイルの内容が変更されることはない。
リングバッファとログファイルは別個のものであり、一方を手動でクリアしても、もう一方には影響はない。
